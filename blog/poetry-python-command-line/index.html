<!doctype html> <html lang=en> <head> <meta charset=utf-8> <meta content="width=device-width,initial-scale=1" name=viewport> <meta content=#333333 name=theme-color> <base href=/ > <link href=global.css rel=stylesheet> <link href=prism-theme.css rel=stylesheet> <link href=manifest.json rel=manifest> <link href=favicon.png rel=icon type=image/png> <link href=client/main.456240545.css rel=stylesheet><link href=client/client.0e3ed4fc.css rel=stylesheet> <script data-svelte=svelte-k1jf8d async src="https://www.googletagmanager.com/gtag/js?id=G-RTWKBNY4CM"></script><script data-svelte=svelte-k1jf8d>window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-RTWKBNY4CM', {
      client_storage: 'none',
    }); </script> <script>__SAPPER__={baseUrl:"",preloaded:[void 0,null,{}]};if('serviceWorker' in navigator)navigator.serviceWorker.register('/service-worker.js');(function(){try{eval("async function x(){}");var main="/client/client.0e3ed4fc.js"}catch(e){main="/client/legacy/client.29a4ccbb.js"};var s=document.createElement("script");try{new Function("if(0)import('')")();s.src=main;s.type="module";s.crossOrigin="use-credentials";}catch(e){s.src="/client/shimport@1.0.1.js";s.setAttribute("data-main",main);}document.head.appendChild(s);}());</script> <link href=/client/main.456240545.css rel=preload as=style><link href=/client/client.0e3ed4fc.css rel=preload as=style></head> <body> <div id=sapper> <nav class=svelte-1wirryz><ul class=svelte-1wirryz><li class=svelte-1wirryz><a href=. class=svelte-1wirryz>home</a></li> <li class=svelte-1wirryz><a href=about class=svelte-1wirryz>about</a></li> <li class=svelte-1wirryz><a href=blog class="svelte-1wirryz selected" rel=prefetch>blog</a></li> <li class=svelte-1wirryz><a href=tags class=svelte-1wirryz rel=prefetch>tags</a></ul></nav> <main class=svelte-1raapg9><h1>Using Poetry and Click to create a command line application</h1> <img alt="" src=/icons/clock.svg> <time class=svelte-dplvyx datetime=2021-12-30T17:19:58.180Z>2021-12-30</time> <div id=tagheader class=svelte-higkw2><h5>More about</h5></div> <div id=tagcontainer class=svelte-higkw2><span class=svelte-higkw2 id=tag><img alt="" src=/icons/tag.svg> <a href="tags/poetry python">poetry python</a> </span></div> <article class=svelte-1nmnuuz id=article><p><a href=https://python-poetry.org/ rel=nofollow>Poetry</a> makes packaging a Python application easy. <a href=https://click.palletsprojects.com/ rel=nofollow>Click</a> makes it easy to create command line applications in Python. How can these two tools be used together?</p> <cite><a href=https://github.com/dataewan/kindlenotes2md>kindlenotes2md</a></cite> <p>I’ve used this pattern in the tool <code>kindlenotes2md</code> if you want to see a working example. Here I’m just going to talk about the most important points. I assume that you’ve already got a poetry project up and running, either by running <code>poetry new</code> to create a new project, or by <code>poetry init</code> in an existing one.</p> <p>Now create a command line application from your code.</p> <h1>Make an entry point in your pyproject.toml</h1> <p>Add a section in your <code>pyproject.toml</code> file.</p> <pre class=language-toml><code class=language-toml><span class="token punctuation">[</span><span class="token class-name table">tool.poetry.scripts</span><span class="token punctuation">]</span>
<span class="token key property">kindlenotes2md</span> <span class="token punctuation">=</span> <span class="token string">"kindlenotes2md.notes:cli"</span></code></pre> <p>There are 4 important parts to this line.</p> <p><code>kindlenotes2md</code> for the first time is the name of the executable script, so what you’ll be typing in on the command line.</p> <p><code>kindlenotes2md</code> for the second time is the name of the module. They don’t need to be called the same thing.</p> <p><code>notes</code> is the name of the python file in the module that contains the function that you’ll use as the entry point to your application.</p> <p><code>cli</code> is the name of the function that you’ll call when typing the command line.</p> <h1>Make the function for the command line application</h1> <p>If I run <code>poetry shell</code> first to set a virtual environment up, the function <code>cli</code> will be run when I run <code>kindlenotes2md</code> in my command line. To make this useful, use click decorators to pass parameters into the function from the command line.</p> <pre class=language-python><code class=language-python><span class="token keyword">import</span> click

<span class="token punctuation annotation decorator">@click<span class="token punctuation">.</span>command</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation annotation decorator">@click<span class="token punctuation">.</span>argument</span><span class="token punctuation">(</span><span class="token string">"inputfilename"</span><span class="token punctuation">)</span>
<span class="token punctuation annotation decorator">@click<span class="token punctuation">.</span>option</span><span class="token punctuation">(</span><span class="token string">"-o"</span><span class="token punctuation">,</span> <span class="token string">"--outfilename"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">cli</span><span class="token punctuation">(</span>inputfilename<span class="token punctuation">,</span> outfilename<span class="token punctuation">)</span><span class="token punctuation">:</span>
    checkfile<span class="token punctuation">(</span>inputfilename<span class="token punctuation">)</span>
    contents <span class="token operator">=</span> read_file<span class="token punctuation">(</span>inputfilename<span class="token punctuation">)</span>
    book_notes <span class="token operator">=</span> parse_contents<span class="token punctuation">(</span>contents<span class="token punctuation">)</span>
    markdown <span class="token operator">=</span> md_output<span class="token punctuation">(</span>book<span class="token operator">=</span>book_notes<span class="token punctuation">)</span>
    <span class="token keyword">if</span> outfilename <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>markdown<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        save_to_file<span class="token punctuation">(</span>markdown<span class="token punctuation">,</span> outfilename<span class="token punctuation">)</span></code></pre> <h1>How to unit test?</h1> <aside><a href=https://click.palletsprojects.com/en/8.0.x/testing/ >Click testing</a></aside> <p>Click provides the <code>CliRunner</code>, which lets you run commands as command line scripts. You use this in your <code>pytest</code> unit tests. This test tests what happens if the file isn’t found (exit code 1), and when it runs successfully.</p> <pre class=language-python><code class=language-python><span class="token keyword">from</span> click<span class="token punctuation">.</span>testing <span class="token keyword">import</span> CliRunner

<span class="token keyword">from</span> kindlenotes2md <span class="token keyword">import</span> notes

<span class="token keyword">def</span> <span class="token function">test_cli</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    runner <span class="token operator">=</span> CliRunner<span class="token punctuation">(</span><span class="token punctuation">)</span>
    result <span class="token operator">=</span> runner<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span>notes<span class="token punctuation">.</span>cli<span class="token punctuation">,</span> <span class="token string">"notexist.html"</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> result<span class="token punctuation">.</span>exit_code <span class="token operator">==</span> <span class="token number">1</span>
    result <span class="token operator">=</span> runner<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span>notes<span class="token punctuation">.</span>cli<span class="token punctuation">,</span> <span class="token string">"tests/test_data.html"</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> result<span class="token punctuation">.</span>exit_code <span class="token operator">==</span> <span class="token number">0</span></code></pre></article></main></div> 